<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=480,initial-scale=1.5" />
		<title>robeCOCOA TEK Bookmarklet</title>
	</head>
	<body>
		<h1>probeCOCOA TEK Bookmarklet</h1>
		<div>
			<p><a id="bookmarkletAncker" href="javascrpt:void(0) ">bookmarklet</a></p>
			<textarea id="bookmarkletSource"> </textarea>
		</div>
		<script>
			const url = location.href;
			const origin = location.origin;
			const d = document;
			const a = d.getElementById('bookmarkletAncker');
			const s = (event) => {
				const t = event.target;
				a.href = `javascript:(()=>{${t.value}})()`;
			};
			const t = d.getElementById('bookmarkletSource');
			t.addEventListener('input', s);
			const f = async (path, ct = 'application/javascript') => {
				const r = {
					method: 'GET',
					mode: 'cors',
					cache: 'no-cache',
					credentials: 'omit',
					redirect: 'follow',
					referrer: 'no-referrer',
					headers: { 'Content-Type': ct },
				};
				console.log(path);
				console.log(r);
				const res = await fetch(path, r);
				return await res.text();
			};
			const to64 = (s) => {
				const u = new Uint16Array(s.length);
				for (let i = 0; i < u.length; i++) {
					u[i] = s.charCodeAt(i);
				}
				const c = String.fromCharCode(...new Uint8Array(u.buffer));
				return btoa(c);
			};
			f(`${url}dist/bookmarklet.js`).then((s) => {
				const sb64 = to64(s);
				const o = `const l=()=>{
				const f=(e)=>{
					const a=atob(e);
  					const b=new Uint8Array(a.length);
					for(let i=0;i<b.length;i++){
						b[i]=a.charCodeAt(i);
					}
  					return String.fromCharCode(...new Uint16Array(b.buffer));
				};
				const ns='http://www.w3.org/1999/xhtml';
				const d=document;
				const e=d.getElementsByTagName('Error')[0];
				if(!d.head||(e&&!e.parentNode)){
					console.log(e);
					console.log(e);
					console.log("d");
					console.log(d);
					d.removeChild(e);
					const dt=d.implementation.createDocumentType("html","","");
					const doc=d.implementation.createDocument(ns, 'html', dt);
					const h=doc.createElementNS(ns, 'head');
					const b=doc.createElementNS(ns, 'body');
					const m=doc.documentElement;
					m.appendChild(h);
					m.appendChild(b);
					d.appendChild(m,true);
					m.setAttribute("xmlns",ns);
					console.log(m);
					console.log("d");
					console.log(d);
				}else{
					const b=d.getElementsByTagName('body')[0];
					for(let child of b.children){
						b.removeChild(child);
					}
					for(let child of b.children){
						b.removeChild(child);
					}
				}
				const b=d.getElementsByTagName('body')[0];
			  const g=(e)=>{
				  alert("aaaa");
				  if(e.origin==='${origin}')return;
				  eval(e.data);
			  };
			  const i=d.createElementNS(ns,'iframe');
			  b.appendChild(i);
			  i.onload=()=>{
			  	i.contentWindow.postMessage({}, '*');
			  };
			  i.setAttribute('src', '${url}');
			  i.setAttribute('height', 0);
			  i.setAttribute('width', 0);
			  console.log('C01');
			  b.appendChild(i);
			  window.addEventListener('message', g, false);
				eval(f('${sb64}'));	
				};
				l();`;

				t.value = o
					.split('\t')
					.join('')
					.split('\n')
					.join('');
				setTimeout(() => {
					const event = new Event('input');
					t.dispatchEvent(event);
				});
				console.log('length:' + t.value.length);
				console.log('A02');
			});
		</script>
	</body>
</html>
